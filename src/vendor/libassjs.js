// SubtitlesOctopus build.
// Original project available at https://github.com/Dador/JavascriptSubtitlesOctopus under MIT license

var SubtitlesOctopus=function(e){var t=!1;try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));e instanceof WebAssembly.Module&&(t=new WebAssembly.Instance(e)instanceof WebAssembly.Instance)}}catch(e){}console.log("WebAssembly support detected: "+(t?"yes":"no"));var a=this;function r(){var e=a.renderFramesData,t=performance.now();a.ctx.clearRect(0,0,a.canvas.width,a.canvas.height);for(var r=0;r<e.canvases.length;r++){var n=e.canvases[r];a.bufferCanvas.width=n.w,a.bufferCanvas.height=n.h;var s=new Uint8ClampedArray(n.buffer);if(a.hasAlphaBug)for(var o=3;o<s.length;o+=4)s[o]=s[o]>=1?s[o]:1;var i=new ImageData(s,n.w,n.h);a.bufferCanvasCtx.putImageData(i,0,0),a.ctx.drawImage(a.bufferCanvas,n.x,n.y)}if(a.debug){var c=Math.round(performance.now()-t);console.log(Math.round(e.spentTime)+" ms (+ "+c+" ms draw)"),a.renderStart=performance.now()}}function n(){var e=a.renderFramesData,t=performance.now();a.ctx.clearRect(0,0,a.canvas.width,a.canvas.height);for(var r=0;r<e.bitmaps.length;r++){var n=e.bitmaps[r];a.ctx.drawImage(n.bitmap,n.x,n.y)}if(a.debug){var s=Math.round(performance.now()-t);console.log(e.bitmaps.length+" bitmaps, libass: "+Math.round(e.libassTime)+"ms, decode: "+Math.round(e.decodeTime)+"ms, draw: "+s+"ms"),a.renderStart=performance.now()}}a.canvas=e.canvas,a.lossyRender=e.lossyRender,a.isOurCanvas=!1,a.video=e.video,a.canvasParent=null,a.fonts=e.fonts||[],a.availableFonts=e.availableFonts||[],a.onReadyEvent=e.onReady,a.workerUrl=t?e.workerUrl||"subtitles-octopus-worker.js":e.legacyWorkerUrl||"subtitles-octopus-worker-legacy.js",a.subUrl=e.subUrl,a.subContent=e.subContent||null,a.onErrorEvent=e.onError,a.debug=e.debug||!1,a.lastRenderTime=0,a.pixelRatio=window.devicePixelRatio||1,a.timeOffset=e.timeOffset||0,a.hasAlphaBug=!1,function(){if("function"==typeof ImageData.prototype.constructor)try{return void new window.ImageData(new Uint8ClampedArray([0,0,0,0]),1,1)}catch(e){console.log("detected that ImageData is not constructable despite browser saying so")}var e=document.createElement("canvas").getContext("2d");window.ImageData=function(){var t=0;if(arguments[0]instanceof Uint8ClampedArray)var a=arguments[t++];var r=arguments[t++],n=arguments[t],s=e.createImageData(r,n);return a&&s.data.set(a),s}}(),a.workerError=function(e){if(console.error("Worker error: ",e),a.onErrorEvent&&a.onErrorEvent(e),!a.debug)throw a.dispose(),new Error("Worker error: "+e)},a.init=function(){window.Worker?(a.worker||(a.worker=new Worker(a.workerUrl),a.worker.onmessage=a.onWorkerMessage,a.worker.onerror=a.workerError),a.workerActive=!1,a.createCanvas(),a.setVideo(e.video),a.setSubUrl(e.subUrl),a.worker.postMessage({target:"worker-init",width:a.canvas.width,height:a.canvas.height,URL:document.URL,currentScript:a.workerUrl,preMain:!0,fastRender:a.lossyRender,subUrl:a.subUrl,subContent:a.subContent,fonts:a.fonts,availableFonts:a.availableFonts,debug:a.debug})):a.workerError("worker not supported")},a.createCanvas=function(){a.canvas||(a.video?(a.isOurCanvas=!0,a.canvas=document.createElement("canvas"),a.canvas.className="libassjs-canvas",a.canvas.style.display="none",a.canvasParent=document.createElement("div"),a.canvasParent.className="libassjs-canvas-parent",a.canvasParent.appendChild(a.canvas),a.video.nextSibling?a.video.parentNode.insertBefore(a.canvasParent,a.video.nextSibling):a.video.parentNode.appendChild(a.canvasParent)):a.canvas||a.workerError("Don't know where to render: you should give video or canvas in options.")),a.ctx=a.canvas.getContext("2d"),a.bufferCanvas=document.createElement("canvas"),a.bufferCanvasCtx=a.bufferCanvas.getContext("2d"),a.bufferCanvas.width=1,a.bufferCanvas.height=1;var e=new Uint8ClampedArray([0,255,0,0]),t=new ImageData(e,1,1);a.bufferCanvasCtx.clearRect(0,0,1,1),a.ctx.clearRect(0,0,1,1);var r=a.ctx.getImageData(0,0,1,1).data;a.bufferCanvasCtx.putImageData(t,0,0),a.ctx.drawImage(a.bufferCanvas,0,0);var n=a.ctx.getImageData(0,0,1,1).data;a.hasAlphaBug=r[1]!=n[1],a.hasAlphaBug&&console.log("Detected a browser having issue with transparent pixels, applying workaround")},a.setVideo=function(e){if(a.video=e,a.video){var t=function(){a.setCurrentTime(e.currentTime+a.timeOffset)};a.video.addEventListener("timeupdate",t,!1),a.video.addEventListener("playing",function(){a.setIsPaused(!1,e.currentTime+a.timeOffset)},!1),a.video.addEventListener("pause",function(){a.setIsPaused(!0,e.currentTime+a.timeOffset)},!1),a.video.addEventListener("seeking",function(){a.video.removeEventListener("timeupdate",t)},!1),a.video.addEventListener("seeked",function(){a.video.addEventListener("timeupdate",t,!1),a.setCurrentTime(e.currentTime+a.timeOffset)},!1),a.video.addEventListener("ratechange",function(){a.setRate(e.playbackRate)},!1),a.video.addEventListener("timeupdate",function(){a.setCurrentTime(e.currentTime+a.timeOffset)},!1),a.video.addEventListener("waiting",function(){a.setIsPaused(!0,e.currentTime+a.timeOffset)},!1),document.addEventListener("fullscreenchange",a.resizeWithTimeout,!1),document.addEventListener("mozfullscreenchange",a.resizeWithTimeout,!1),document.addEventListener("webkitfullscreenchange",a.resizeWithTimeout,!1),document.addEventListener("msfullscreenchange",a.resizeWithTimeout,!1),window.addEventListener("resize",a.resizeWithTimeout,!1),"undefined"!=typeof ResizeObserver&&(a.ro=new ResizeObserver(a.resizeWithTimeout),a.ro.observe(a.video)),a.video.videoWidth>0?a.resize():a.video.addEventListener("loadedmetadata",function(e){e.target.removeEventListener(e.type,arguments.callee),a.resize()},!1)}},a.getVideoPosition=function(){var e=a.video.videoWidth/a.video.videoHeight,t=a.video.offsetWidth,r=a.video.offsetHeight,n=t,s=r;return t/r>e?n=Math.floor(r*e):s=Math.floor(t/e),{width:n,height:s,x:(t-n)/2,y:(r-s)/2}},a.setSubUrl=function(e){a.subUrl=e},a.renderFrameData=null,a.workerActive=!1,a.frameId=0,a.onWorkerMessage=function(e){a.workerActive||(a.workerActive=!0,a.onReadyEvent&&a.onReadyEvent());var t=e.data;switch(t.target){case"stdout":console.log(t.content);break;case"console-log":console.log.apply(console,JSON.parse(t.content));break;case"console-debug":console.debug.apply(console,JSON.parse(t.content));break;case"console-info":console.info.apply(console,JSON.parse(t.content));break;case"console-warn":console.warn.apply(console,JSON.parse(t.content));break;case"console-error":console.error.apply(console,JSON.parse(t.content));break;case"stderr":console.error(t.content);break;case"window":window[t.method]();break;case"canvas":switch(t.op){case"getContext":a.ctx=a.canvas.getContext(t.type,t.attributes);break;case"resize":a.resize(t.width,t.height);break;case"renderCanvas":a.lastRenderTime<t.time&&(a.lastRenderTime=t.time,a.renderFramesData=t,window.requestAnimationFrame(r));break;case"renderFastCanvas":a.lastRenderTime<t.time&&(a.lastRenderTime=t.time,a.renderFramesData=t,window.requestAnimationFrame(n));break;case"setObjectProperty":a.canvas[t.object][t.property]=t.value;break;default:throw"eh?"}break;case"tick":a.frameId=t.id,a.worker.postMessage({target:"tock",id:a.frameId});break;case"custom":if(!a.onCustomMessage)throw"Custom message received but client onCustomMessage not implemented.";a.onCustomMessage(e);break;case"setimmediate":a.worker.postMessage({target:"setimmediate"});break;case"get-events":console.log(t.target),console.log(t.events);break;case"get-styles":console.log(t.target),console.log(t.styles);break;default:throw"what? "+t.target}},a.resize=function(e,t,r,n){var s=null;if(r=r||0,n=n||0,(!e||!t)&&a.video){e=(s=a.getVideoPosition()).width*a.pixelRatio,t=s.height*a.pixelRatio;var o=a.canvasParent.getBoundingClientRect().top-a.video.getBoundingClientRect().top;r=s.y-o,n=s.x}e&&t?a.canvas.width==e&&a.canvas.height==t&&a.canvas.style.top==r&&a.canvas.style.left==n||(a.canvas.width=e,a.canvas.height=t,null!=s&&(a.canvasParent.style.position="relative",a.canvas.style.display="block",a.canvas.style.position="absolute",a.canvas.style.width=s.width+"px",a.canvas.style.height=s.height+"px",a.canvas.style.top=r+"px",a.canvas.style.left=n+"px",a.canvas.style.pointerEvents="none"),a.worker.postMessage({target:"canvas",width:a.canvas.width,height:a.canvas.height})):a.video||console.error("width or height is 0. You should specify width & height for resize.")},a.resizeWithTimeout=function(){a.resize(),setTimeout(a.resize,100)},a.runBenchmark=function(){a.worker.postMessage({target:"runBenchmark"})},a.customMessage=function(e,t){t=t||{},a.worker.postMessage({target:"custom",userData:e,preMain:t.preMain})},a.setCurrentTime=function(e){a.worker.postMessage({target:"video",currentTime:e})},a.setTrackByUrl=function(e){a.worker.postMessage({target:"set-track-by-url",url:e})},a.setTrack=function(e){a.worker.postMessage({target:"set-track",content:e})},a.freeTrack=function(e){a.worker.postMessage({target:"free-track"})},a.render=a.setCurrentTime,a.setIsPaused=function(e,t){a.worker.postMessage({target:"video",isPaused:e,currentTime:t})},a.setRate=function(e){a.worker.postMessage({target:"video",rate:e})},a.dispose=function(){a.worker.postMessage({target:"destroy"}),a.worker.terminate(),a.workerActive=!1,a.video&&a.video.parentNode.removeChild(a.canvasParent)},a.createEvent=function(e){a.worker.postMessage({target:"create-event",event:e})},a.getEvents=function(){a.worker.postMessage({target:"get-events"})},a.setEvent=function(e,t){a.worker.postMessage({target:"set-event",event:e,index:t})},a.removeEvent=function(e){a.worker.postMessage({target:"remove-event",index:e})},a.createStyle=function(e){a.worker.postMessage({target:"create-style",style:e})},a.getStyles=function(){a.worker.postMessage({target:"get-styles"})},a.setStyle=function(e,t){a.worker.postMessage({target:"set-style",style:e,index:t})},a.removeStyle=function(e){a.worker.postMessage({target:"remove-style",index:e})},a.init()};

export { SubtitlesOctopus }
