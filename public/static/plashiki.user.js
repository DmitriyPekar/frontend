// ==UserScript==
// @name            PlaShiki
// @namespace       https://shikimori.online
// @version         1.0.1
// @description     Скрипт-компаньон для PlaShiki
// @description:en  Companion script for PlaShiki
// @author          teidesu
// @include /^https?:\/\/shikimori\.o(?:ne|rg)/
// @include /^https?:\/\/(beta\.)?(?:plashiki\.(?:tk|online|su)|shikimori\.online|(?:127.0.0.1|localhost):8123)/
// @updateURL       https://plashiki.su/assets/plashiki.user.js
// @run-at          document-body
// @grant           GM_xmlhttpRequest
// @grant           GM_setValue
// @grant           GM_getValue
// @connect         self
// @connect         plashiki.su
// @connect         shikimori.one
// @connect         anime365.ru
// @connect         hentai365.ru
// @connect         smotret-anime-365.ru
// @connect         smotretanime.ru
// @connect         *
// ==/UserScript==
function ownKeys(a,e){var i=Object.keys(a);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(a);e&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})),i.push.apply(i,t)}return i}function _objectSpread(a){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(i),!0).forEach(function(e){_defineProperty(a,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach(function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(i,e))})}return a}function _slicedToArray(e,a){return _arrayWithHoles(e)||_iterableToArrayLimit(e,a)||_unsupportedIterableToArray(e,a)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,a){if(e){if("string"==typeof e)return _arrayLikeToArray(e,a);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,a):void 0}}function _arrayLikeToArray(e,a){(null==a||a>e.length)&&(a=e.length);for(var i=0,t=new Array(a);i<a;i++)t[i]=e[i];return t}function _iterableToArrayLimit(e,a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var i=[],t=!0,n=!1,r=void 0;try{for(var o,d=e[Symbol.iterator]();!(t=(o=d.next()).done)&&(i.push(o.value),!a||i.length!==a);t=!0);}catch(e){n=!0,r=e}finally{try{t||null==d.return||d.return()}finally{if(n)throw r}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,a){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,a){for(var i=0;i<a.length;i++){var t=a[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function _createClass(e,a,i){return a&&_defineProperties(e.prototype,a),i&&_defineProperties(e,i),e}function _defineProperty(e,a,i){return a in e?Object.defineProperty(e,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[a]=i,e}var UserScript=function(){"use strict";function e(){_classCallCheck(this,e),_defineProperty(this,"__version","1.0.1"),_defineProperty(this,"__debug",!1),_defineProperty(this,"__matchers",[]),_defineProperty(this,"__assets",{"inject.scss":'.shiki-theme#plashiki-inject{letter-spacing:.7px;text-transform:uppercase;display:block;text-align:center;position:relative;padding:5px;overflow:hidden;border-width:0;outline:none;border-radius:24px;box-shadow:0 1px 4px rgba(0,0,0,.6);color:#ecf0f1;transition:background-color .3s,color .3s;width:100%;background-color:var(--color-primary);max-width:200px;margin-top:12px;margin-left:auto;margin-right:auto}.shiki-theme#plashiki-inject:hover{background-color:var(--color-primary-hovered)}.shiki-theme#plashiki-inject:before{content:"";position:absolute;top:50%;left:50%;display:block;transform:translate(-50%, -50%);width:0;padding-top:0;border-radius:100%;opacity:0;transition:opacity .3s ease-out,width 1ms ease .3s,padding-top 1ms ease .3s;background-color:rgba(236,240,241,.3)}.shiki-theme#plashiki-inject:active:before{opacity:1;width:120%;padding-top:120%;transition:width .2s ease-out,padding-top .2s ease-out,opacity 1ms ease-out}@media(max-width: 767px){.l-top_menu-v2 .menu-dropdown.profile.plashiki-has-galo4ka>span:before{content:"";border-radius:50%;background-color:#536dfe;background-image:url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0ibWRpLXN0YXIiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+PHBhdGggZD0iTTEyLDE3LjI3TDE4LjE4LDIxTDE2LjU0LDEzLjk3TDIyLDkuMjRMMTQuODEsOC42MkwxMiwyTDkuMTksOC42MkwyLDkuMjRMNy40NSwxMy45N0w1LjgyLDIxTDEyLDE3LjI3WiIgLz48L3N2Zz4=);background-size:75%;background-repeat:no-repeat;background-position:center;z-index:999;width:12px !important;height:12px !important;position:absolute;bottom:0;right:0;margin:8px}}.l-top_menu-v2 .menu-dropdown.profile.plashiki-has-galo4ka .nickname:after{content:"";border-radius:50%;background-color:#536dfe;background-image:url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0ibWRpLXN0YXIiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+PHBhdGggZD0iTTEyLDE3LjI3TDE4LjE4LDIxTDE2LjU0LDEzLjk3TDIyLDkuMjRMMTQuODEsOC42MkwxMiwyTDkuMTksOC42MkwyLDkuMjRMNy40NSwxMy45N0w1LjgyLDIxTDEyLDE3LjI3WiIgLz48L3N2Zz4=);background-size:75%;background-repeat:no-repeat;background-position:center;z-index:999;height:10px;width:10px;display:inline-block;margin:0 4px}.b-user.avatar>a.avatar.plashiki-has-galo4ka:before,.b-user.named_avatar>a.avatar.plashiki-has-galo4ka:before{content:"";border-radius:50%;background-color:#536dfe;background-image:url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0ibWRpLXN0YXIiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+PHBhdGggZD0iTTEyLDE3LjI3TDE4LjE4LDIxTDE2LjU0LDEzLjk3TDIyLDkuMjRMMTQuODEsOC42MkwxMiwyTDkuMTksOC42MkwyLDkuMjRMNy40NSwxMy45N0w1LjgyLDIxTDEyLDE3LjI3WiIgLz48L3N2Zz4=);background-size:75%;background-repeat:no-repeat;background-position:center;z-index:999;position:absolute;bottom:0;width:12px;height:12px;left:50%;margin:0 4px}.b-user.named_avatar>a.avatar.plashiki-has-galo4ka:before{width:16px;height:16px;margin-bottom:20px}.profile-head .head.misc.plashiki-has-galo4ka>h1:after,.profile-head .head.misc.plashiki-has-galo4ka>h1.aliases:after{content:"";border-radius:50%;background-color:#536dfe;background-image:url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0ibWRpLXN0YXIiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+PHBhdGggZD0iTTEyLDE3LjI3TDE4LjE4LDIxTDE2LjU0LDEzLjk3TDIyLDkuMjRMMTQuODEsOC42MkwxMiwyTDkuMTksOC42MkwyLDkuMjRMNy40NSwxMy45N0w1LjgyLDIxTDEyLDE3LjI3WiIgLz48L3N2Zz4=);background-size:75%;background-repeat:no-repeat;background-position:center;z-index:999;width:14px;height:14px;display:inline-block;margin:0 4px 0 8px}.b-comment.shiki-object .inner header .name-date .name.plashiki-has-galo4ka:after,.b-user.moderation .name.plashiki-has-galo4ka:after,.b-user.detailed .name.plashiki-has-galo4ka:after{content:"";border-radius:50%;background-color:#536dfe;background-image:url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0ibWRpLXN0YXIiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+PHBhdGggZD0iTTEyLDE3LjI3TDE4LjE4LDIxTDE2LjU0LDEzLjk3TDIyLDkuMjRMMTQuODEsOC42MkwxMiwyTDkuMTksOC42MkwyLDkuMjRMNy40NSwxMy45N0w1LjgyLDIxTDEyLDE3LjI3WiIgLz48L3N2Zz4=);background-size:75%;background-repeat:no-repeat;background-position:center;z-index:999;width:10px;height:10px;display:inline-block;margin:0 6px}'}),_defineProperty(this,"__i18n",{ru:{Watch:"Смотреть онлайн",Banned:"Забанен",Admin:"Админ",Moderator:"Модератор",Trusted:"Доверенный",AddedVideos:["добавленных видео","добавленное видео","добавленных видео","добавленных видео"],AtPlashiki:"на PlaShiki"}}),_defineProperty(this,"__lang","ru")}return _createClass(e,[{key:"match",value:function(e,a){if(!(e instanceof RegExp))throw Error("Invalid matcher");this.__matchers.push({matcher:e,func:a})}},{key:"asset",value:function(e){return this.__assets[e]}},{key:"execute",value:function(t){this.__matchers.forEach(function(e){var a=e.matcher,i=e.func;t.match(a)&&i()})}},{key:"tr",value:function(e){return this.__i18n[this.__lang][e]}},{key:"trc",value:function(e,a){if(this.__i18n[this.__lang][e]){var i=this.__i18n[this.__lang][e].length,t=0;if("ru"===this.__lang){0!==a&&1!==i||(t=0);var n=10<a&&a<20;t=!n&&a%10==1?1:!n&&2<=a%10&&a%10<=4||i<4?2:3}return this.__i18n[this.__lang][e][t]}}}]),e}(),ShikimoriRegex=/^https?:\/\/shikimori\.o(?:ne|rg)/,PlashikiRegex=/^https?:\/\/(beta\.)?(?:plashiki\.(?:tk|online|su)|shikimori\.online|(?:127.0.0.1|localhost):8123)/,us=new UserScript,$=document.querySelector.bind(document),$$=document.querySelectorAll.bind(document),API_DOMAIN="https://plashiki.su/api",galo4kiEnabled=!0;function style(){if(!document.getElementById("plashiki-inject-css")){var e=document.createElement("style");e.type="text/css",e.id="plashiki-inject-css",e.innerHTML=us.asset("inject.scss"),document.getElementsByTagName("head")[0].appendChild(e)}}function xhr(n){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return new Promise(function(e,a){var i=new XMLHttpRequest;i.open(r.method||"GET",n);var t="object"===_typeof(r.body)?JSON.stringify(r.body):r.body;i.send(t),i.onload=function(){return e(i.response)},i.onerror=a})}var galo4kiIndex={};function addGalo4kaEl(e,a,i){i&&galo4kiEnabled&&(a in e||(e[a]=[]),e[a].push(i))}function drawGalo4ki(e){Object.entries(e).forEach(function(e){var a=_slicedToArray(e,2),i=a[0],t=a[1];galo4kiIndex[i]&&t.forEach(function(e){return e.classList.add("plashiki-has-galo4ka")})})}function loadGalo4ki(a,i){if(galo4kiEnabled){var t=Object.keys(a).filter(function(e){return!(e in galo4kiIndex)});if(!t.length)return drawGalo4ki(a);var e=API_DOMAIN+"/v2/donators/from?ids="+encodeURIComponent(t.join(","));i&&(e+="&service="+i),xhr(e).then(function(e){"string"==typeof e&&(e=JSON.parse(e)),e.ok?(e.result.forEach(function(e){var a=e.id;i&&(a=e.external_ids[i]),galo4kiIndex[a]=!0}),t.forEach(function(e){void 0===galo4kiIndex[e]&&(galo4kiIndex[e]=!1)})):console.warn("galo4ki load error: "+e),drawGalo4ki(a)}).catch(console.warn)}}us.match(ShikimoriRegex,function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,a=location.href.match(/^https?:\/\/shikimori\.o(?:ne|rg)\/animes\/[a-zA-Z]*(\d+)(?:.+)?$/);if(null!==a&&void 0!==a[1]){var i=a[1],t=document.getElementById("plashiki-inject");t&&t.remove();var n=document.querySelectorAll("div.c-info-right > .block");if(0!==n.length){var r=n[n.length-1],o=$("#custom_css");if(o&&-1<o.innerText.indexOf("shiki-theme")){var d=document.createElement("a");d.className="shiki-theme",d.id="plashiki-inject",d.href="https://plashiki.su/anime/"+i,d.innerHTML=us.tr("Watch"),r.appendChild(d)}else{var c=document.createElement("div");c.className="watch-online",c.id="plashiki-inject",c.innerHTML='\n            <div class="line">\n                <a class="b-link_button dark" href="https://plashiki.su/anime/'.concat(i,'" target="_blank" title="PlaShiki">\n                    <span>').concat(us.tr("Watch"),'</span>\n                </a>\n            </div>\n            <div class="kind">PlaShiki</div>\n            '),r.appendChild(c)}}else setTimeout(s,100,e+1)}}function e(){if(galo4kiEnabled){var t={},e=JSON.parse($("body").dataset.user||"{}").id||null;e&&addGalo4kaEl(t,e,$(".menu-dropdown.profile")),$$(".b-user").forEach(function(e){var a=e.attributes.id.value,i=e.querySelector(".name");addGalo4kaEl(t,a,i||e.querySelector("img").parentElement)}),$$(".profile-head").forEach(function(e){addGalo4kaEl(t,e.dataset.userId,e.querySelector(".head.misc>h1").parentElement)}),$$(".b-user.detailed, .b-user.moderation").forEach(function(e){addGalo4kaEl(t,e.attributes.id.value,e.querySelector(".avatar-name .name"))}),$$(".b-comment.shiki-object").forEach(function(e){addGalo4kaEl(t,e.dataset.user_id,e.querySelector(".inner header .name-date .name"))}),loadGalo4ki(t,"S")}}var i={};function a(){style(),s(),e(),function(){var e=$(".profile-head");if(e&&e.dataset.userId){var a=e.dataset.userId;i[a]||(i[a]=!0,xhr(API_DOMAIN+"/v2/users?withStat&shikiId="+e.dataset.userId).then(function(e){if("string"==typeof e&&(e=JSON.parse(e)),e.ok){e=e.result;var a=$(".c-additionals"),i=$(".plashiki-inject-stats");i&&i.remove();var t="";if(e.banned?t='<span style="color: #de3e35">'.concat(us.tr("Banned"),"</span>"):e.admin?t='<span style="color: #2c7ae2">'.concat(us.tr("Admin"),"</span>"):e.moderator?t='<span style="color: #2c7ae2">'.concat(us.tr("Moderator"),"</span>"):e.trusted&&(t='<span style="color: #1b9a59">'.concat(us.tr("Trusted"),"</span>")),0<e.added&&(t&&(t+=", "),t+="".concat(e.added," ").concat(us.trc("AddedVideos",e.added))),t){if(!a){var n=$(".profile-head .c-info"),r=document.createElement("div");r.className="c-additionals","en"===document.body.dataset.locale?r.innerHTML="<b>Activity:</b>":r.innerHTML="<b>Активность:</b>",a=r,n.appendChild(r)}var o=document.createElement("div");o.dataset.type="plashiki",o.className="plashiki-inject-stats";var d=document.createElement("span");d.innerHTML=t+" "+us.tr("AtPlashiki"),o.appendChild(d),a.appendChild(o)}}}).finally(function(){i[a]=!1}))}}()}var t=!1;document.addEventListener("page:load",a),document.addEventListener("turbolinks:load",function(){a(),t||(unsafeWindow.jQuery(document).on("ajax:complete",function(){return setTimeout(e,25)}),t=!0)}),unsafeWindow.jQuery&&galo4kiEnabled&&(unsafeWindow.jQuery(document).on("ajax:complete",function(){return setTimeout(e,25)}),t=!0),a()}),us.match(PlashikiRegex,function(){unsafeWindow.USERSCRIPT_VERSION=us.__version,unsafeWindow.corsAjax=GM_xmlhttpRequest,unsafeWindow.toggleGalo4ki=function(e){galo4kiEnabled=e,GM_setValue("galo4kiEnabled",e+"")},unsafeWindow.galo4kiEnabled=function(){return Promise.resolve(GM_getValue("galo4kiEnabled")).then(function(e){return"false"!==e})}}),us.execute(location.href);